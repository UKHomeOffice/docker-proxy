---
kind: pipeline
name: default
type: kubernetes

platform:
  os: linux
  arch: amd64

steps:
- name: build-image
  pull: if-not-exists
  image: plugins/docker
  commands:
  - sleep 10
  - docker build -t $${NAME}:$${DRONE_COMMIT_SHA} .
  environment:
    DOCKER_HOST: tcp://172.17.0.1:2375
    NAME: proxy

- name: push_image_master
  pull: if-not-exists
  image: plugins/docker
  commands:
  - FULL_NAME=$${REPO}$${BASE}$${NAME}
  - docker login -u="$${DOCKER_USERNAME}" -p=$${DOCKER_PASSWORD} $${REPO}
  - docker tag $${NAME}:$${DRONE_COMMIT_SHA} $${FULL_NAME}:$${DRONE_COMMIT_SHA}
  - docker tag $${NAME}:$${DRONE_COMMIT_SHA} $${FULL_NAME}:latest
  - docker push $${FULL_NAME}:$${DRONE_COMMIT_SHA}
  - docker push $${FULL_NAME}:latest
  environment:
    BASE: /ukhomeofficedigital/
    DOCKER_HOST: tcp://172.17.0.1:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME: ukhomeofficedigital+proxy
    NAME: proxy
    REPO: quay.io
  when:
    branch:
    - master
    event:
    - push

- name: push_image_tag
  pull: if-not-exists
  image: plugins/docker
  commands:
  - FULL_NAME=$${REPO}$${BASE}$${NAME}:$${DRONE_TAG}
  - docker login -u="$${DOCKER_USERNAME}" -p=$${DOCKER_PASSWORD} $${REPO}
  - docker tag $${NAME}:$${DRONE_COMMIT_SHA} $${FULL_NAME}
  - docker push $${FULL_NAME}
  environment:
    BASE: /ukhomeofficedigital/
    DOCKER_HOST: tcp://172.17.0.1:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME: ukhomeofficedigital+proxy
    NAME: proxy
    REPO: quay.io
  when:
    event:
    - tag

...
